<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Connect - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A0A0A;
        }
        .bg-dark {
            background-color: #0A0A0A;
        }
        .text-accent {
            color: #FF6B00;
        }
        .bg-accent {
            background-color: #FF6B00;
        }
    </style>
</head>
<body class="bg-dark text-white min-h-screen">
    <header class="border-b border-gray-800">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-extrabold">Admin <span class="text-accent">Dashboard</span></h1>
                <p class="text-gray-400 text-sm sm:text-base">Manage blog posts</p>
            </div>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-400 hover:text-accent transition text-sm sm:text-base">View Site</a>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-500 text-white font-semibold text-sm sm:text-base px-4 py-2 rounded-lg transition">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16 py-8 sm:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 sm:gap-10">
            <!-- Create Blog Post -->
            <section class="lg:col-span-1 bg-gray-900 rounded-lg p-6 sm:p-8 shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Create <span class="text-accent">Blog Post</span></h2>
                <p class="text-gray-400 text-sm sm:text-base mb-6">Add new content to the blog.</p>
                <form id="postForm" class="space-y-6">
                    <div>
                        <label for="title" class="block text-white text-sm font-semibold mb-2">Title</label>
                        <input id="title" name="title" type="text" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition" placeholder="Enter blog title">
                    </div>
                    <div>
                        <label for="postImage" class="block text-gray-300 text-sm font-medium mb-2">Image</label>
                        <input type="file" id="postImage" accept="image/*"
                            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition">
                        <p class="text-xs text-gray-500 mt-2">Recommended: High-quality JPG or PNG.</p>
                    </div>
                    <div>
                        <label for="body" class="block text-white text-sm font-semibold mb-2">Body</label>
                        <textarea id="body" name="body" rows="6" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition resize-none" placeholder="Write the blog content"></textarea>
                    </div>
                    <div id="formError" class="hidden bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-sm"></div>
                    <div id="formSuccess" class="hidden bg-green-900/50 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-sm"></div>
                    <button type="submit" id="submitPostBtn" class="w-full bg-accent text-white font-semibold text-sm sm:text-base px-6 py-3 rounded-lg uppercase tracking-wide hover:bg-opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="submitPostText">Publish Post</span>
                        <span id="submitPostLoading" class="hidden">Publishing...</span>
                    </button>
                </form>
            </section>

            <!-- Blog Posts List -->
            <section class="lg:col-span-2 bg-gray-900 rounded-lg p-6 sm:p-8 shadow-lg">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold">Recent <span class="text-accent">Posts</span></h2>
                        <p class="text-gray-400 text-sm sm:text-base">Manage your published content.</p>
                    </div>
                    <button id="refreshPosts" class="w-full sm:w-auto px-4 py-2 bg-gray-800 text-gray-200 border border-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-700 transition">Refresh</button>
                </div>

                <div id="postsList" class="space-y-4">
                    <div class="text-gray-500 text-sm sm:text-base">Loading posts...</div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8be0_AONBFXhM9KXILDGgBGluMyoTB2Y",
            authDomain: "topeblog-76c2f.firebaseapp.com",
            projectId: "topeblog-76c2f",
            storageBucket: "topeblog-76c2f.firebasestorage.app",
            messagingSenderId: "260807786691",
            appId: "1:260807786691:web:675932add872442acfa276",
            measurementId: "G-XYKB3C88NE"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const cloudinaryConfig = {
            cloudName: 'dfzew79my',
            uploadPreset: 'ml_default'
        };

        const logoutBtn = document.getElementById('logoutBtn');
        const postForm = document.getElementById('postForm');
        const submitPostBtn = document.getElementById('submitPostBtn');
        const submitPostText = document.getElementById('submitPostText');
        const submitPostLoading = document.getElementById('submitPostLoading');
        const formError = document.getElementById('formError');
        const formSuccess = document.getElementById('formSuccess');
        const postsList = document.getElementById('postsList');
        const refreshPosts = document.getElementById('refreshPosts');

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
            window.location.href = 'admin.html';
        });

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'admin.html';
            }
        });

        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('hidden');
            formSuccess.classList.add('hidden');

            const title = document.getElementById('title').value.trim();
            const body = document.getElementById('body').value.trim();
            const imageFile = document.getElementById('postImage').files[0];

            if (!title || !body || !imageFile) {
                formError.textContent = 'Please fill in all fields and select an image.';
                formError.classList.remove('hidden');
                return;
            }

            submitPostBtn.disabled = true;
            submitPostText.classList.add('hidden');
            submitPostLoading.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('file', imageFile);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);

                if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset || cloudinaryConfig.cloudName === 'YOUR_CLOUD_NAME') {
                    throw new Error('Cloudinary configuration missing. Please set your cloudName and uploadPreset.');
                }

                const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.error?.message || 'Failed to upload image to Cloudinary.');
                }

                const uploadResult = await uploadResponse.json();
                const imageUrl = uploadResult.secure_url;
                const imagePublicId = uploadResult.public_id;

                await db.collection('posts').add({
                    title,
                    body,
                    imageUrl,
                    imagePublicId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdDate: new Date().toISOString()
                });

                formSuccess.textContent = 'Post published successfully!';
                formSuccess.classList.remove('hidden');
                postForm.reset();
                loadPosts();
            } catch (error) {
                console.error(error);
                formError.textContent = error.message || 'Failed to publish post.';
                formError.classList.remove('hidden');
            } finally {
                submitPostBtn.disabled = false;
                submitPostText.classList.remove('hidden');
                submitPostLoading.classList.add('hidden');
            }
        });

        async function loadPosts() {
            postsList.innerHTML = '<div class="text-gray-500 text-sm sm:text-base">Loading posts...</div>';
            try {
                const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').limit(50).get();
                if (snapshot.empty) {
                    postsList.innerHTML = '<div class="text-gray-500 text-sm sm:text-base">No posts found. Create your first post!</div>';
                    return;
                }

                const fragments = document.createDocumentFragment();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdDate ? new Date(data.createdDate).toLocaleString() : 'Pending...');
                    const previewBody = data.body.length > 220 ? `${data.body.slice(0, 220)}...` : data.body;

                    const article = document.createElement('article');
                    article.className = 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden shadow';
                    article.innerHTML = `
                        <div class="flex flex-col md:flex-row gap-4">
                            ${data.imageUrl ? `
                            <div class="md:w-1/3 flex-shrink-0">
                                <img src="${data.imageUrl}" alt="${data.title}" class="h-48 md:h-full w-full object-cover rounded-lg">
                            </div>` : ''}
                            <div class="flex-1 p-4 sm:p-6 flex flex-col gap-4">
                                <h3 class="text-lg sm:text-xl font-bold text-white mb-2 break-words">${data.title}</h3>
                                <p class="text-gray-400 text-sm mb-4 whitespace-pre-wrap break-words leading-relaxed">${previewBody}</p>
                                <div class="flex items-center justify-between text-xs sm:text-sm text-gray-500 mt-auto gap-4 flex-wrap">
                                    <span class="break-words">${createdAt}</span>
                                    <div class="flex items-center gap-4 flex-wrap">
                                        <a href="blog-post.html?id=${doc.id}" target="_blank" class="text-accent hover:text-accent/80 font-semibold">See more</a>
                                        <button class="text-red-400 hover:text-red-300 font-semibold" data-id="${doc.id}">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    const deleteBtn = article.querySelector('button');
                    deleteBtn.addEventListener('click', () => deletePost(doc.id, data.imagePublicId));
                    fragments.appendChild(article);
                });

                postsList.innerHTML = '';
                postsList.appendChild(fragments);
            } catch (error) {
                console.error(error);
                postsList.innerHTML = '<div class="text-red-400 text-sm">Failed to load posts. Please try again.</div>';
            }
        }

        async function deletePost(postId, imagePublicId) {
            const confirmed = confirm('Are you sure you want to delete this post?');
            if (!confirmed) return;

            try {
                await db.collection('posts').doc(postId).delete();
                console.warn('Cloudinary image not automatically deleted. Remove manually or implement a secure backend using Cloudinary Admin API.', imagePublicId);
                loadPosts();
            } catch (error) {
                console.error(error);
                alert('Failed to delete post. Please try again.');
            }
        }

        refreshPosts.addEventListener('click', loadPosts);
        loadPosts();
    </script>
</body>
</html>
